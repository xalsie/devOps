name: Test Terraform Outputs

on:
  workflow_dispatch:  # Permet de lancer manuellement

env:
  TF_VERSION: "1.6.0"

jobs:
  test-terraform:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infrastructure
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}
        
    - name: Terraform Init
      run: terraform init -backend=false
      
    - name: Terraform Validate
      run: terraform validate
      
    - name: Terraform Plan (Dry Run)
      run: |
        echo "ðŸ§ª Test du plan Terraform..."
        terraform plan -var-file="terraform.tfvars" -no-color
        
    - name: Check outputs definition
      run: |
        echo "ðŸ“‹ VÃ©rification des outputs dÃ©finis:"
        if [ -f "outputs.tf" ]; then
          echo "âœ… Le fichier outputs.tf existe"
          echo "Outputs dÃ©finis:"
          grep -E "^output" outputs.tf || echo "Aucun output trouvÃ©"
        else
          echo "âŒ Le fichier outputs.tf n'existe pas"
          exit 1
        fi
        
    - name: Generate Terraform Report
      run: |
        echo "ðŸ“Š GÃ©nÃ©ration du rapport Terraform..."
        
        # CrÃ©er le rÃ©pertoire de rapport
        mkdir -p ../reports
        
        # Variables
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        REPORT_FILE="../reports/terraform-validation-report.md"
        
        # CrÃ©er le rapport simple
        echo "# Rapport de Validation Terraform" > $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "**Date:** $TIMESTAMP" >> $REPORT_FILE
        echo "**Branche:** ${{ github.ref_name }}" >> $REPORT_FILE
        echo "**Commit:** ${{ github.sha }}" >> $REPORT_FILE
        echo "**Utilisateur:** ${{ github.actor }}" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        
        # Statut
        echo "## Statut de Validation" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "- [x] Terraform Init OK" >> $REPORT_FILE
        echo "- [x] Terraform Validate OK" >> $REPORT_FILE
        echo "- [x] Terraform Plan OK" >> $REPORT_FILE
        echo "- [x] Outputs dÃ©finis OK" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        
        # Outputs disponibles
        echo "## Outputs Terraform" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        
        # VÃ©rifier si l'infrastructure existe dÃ©jÃ 
        if terraform state list >/dev/null 2>&1 && [ $(terraform state list | wc -l) -gt 0 ]; then
          echo "### ðŸš€ Infrastructure dÃ©ployÃ©e - Valeurs actuelles:" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "| Output | Description | Valeur Actuelle |" >> $REPORT_FILE
          echo "|--------|-------------|-----------------|" >> $REPORT_FILE
          
          # Extraire chaque output avec sa description et valeur
          if [ -f "outputs.tf" ]; then
            while IFS= read -r line; do
              if [[ $line =~ ^output ]]; then
                output_name=$(echo "$line" | sed 's/output "\([^"]*\)".*/\1/')
                description=$(awk "/^output \"$output_name\"/,/^}/" outputs.tf | grep -E "description\s*=" | sed 's/.*description\s*=\s*"\([^"]*\)".*/\1/' | head -1)
                
                # RÃ©cupÃ©rer la valeur rÃ©elle
                actual_value=$(terraform output -raw "$output_name" 2>/dev/null || echo "N/A")
                
                # Formatage de la valeur (limiter la longueur pour les valeurs trÃ¨s longues)
                if [ ${#actual_value} -gt 50 ]; then
                  display_value="${actual_value:0:47}..."
                else
                  display_value="$actual_value"
                fi
                
                # Ajouter Ã  la table
                if [ -n "$description" ] && [ "$description" != "" ]; then
                  echo "| \`$output_name\` | $description | \`$display_value\` |" >> $REPORT_FILE
                else
                  echo "| \`$output_name\` | - | \`$display_value\` |" >> $REPORT_FILE
                fi
              fi
            done < outputs.tf
          fi
          echo "" >> $REPORT_FILE
          
          # Afficher Ã©galement la sortie brute complÃ¨te
          echo "<details>" >> $REPORT_FILE
          echo "<summary>ðŸ“‹ Voir tous les outputs (format brut)</summary>" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "\`\`\`" >> $REPORT_FILE
          terraform output >> $REPORT_FILE 2>/dev/null || echo "Erreur lors de la rÃ©cupÃ©ration des outputs" >> $REPORT_FILE
          echo "\`\`\`" >> $REPORT_FILE
          echo "</details>" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
        else
          echo "### â³ Infrastructure non dÃ©ployÃ©e - Outputs qui seront disponibles:" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "| Output | Description |" >> $REPORT_FILE
          echo "|--------|-------------|" >> $REPORT_FILE
          
          # Lister les outputs dÃ©finis sans valeurs
          if [ -f "outputs.tf" ]; then
            while IFS= read -r line; do
              if [[ $line =~ ^output ]]; then
                output_name=$(echo "$line" | sed 's/output "\([^"]*\)".*/\1/')
                description=$(awk "/^output \"$output_name\"/,/^}/" outputs.tf | grep -E "description\s*=" | sed 's/.*description\s*=\s*"\([^"]*\)".*/\1/' | head -1)
                
                if [ -n "$description" ] && [ "$description" != "" ]; then
                  echo "| \`$output_name\` | $description |" >> $REPORT_FILE
                else
                  echo "| \`$output_name\` | - |" >> $REPORT_FILE
                fi
              fi
            done < outputs.tf
          fi
          echo "" >> $REPORT_FILE
        fi
        
        # Instructions
        echo "## Instructions de dÃ©ploiement" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "1. DÃ©ployer: \`./deploy-manual.sh deploy\`" >> $REPORT_FILE
        echo "2. VÃ©rifier: \`./deploy-manual.sh status\`" >> $REPORT_FILE
        echo "3. DÃ©truire: \`./deploy-manual.sh destroy\`" >> $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "---" >> $REPORT_FILE
        echo "*Rapport gÃ©nÃ©rÃ© automatiquement*" >> $REPORT_FILE
        
        echo "âœ… Rapport gÃ©nÃ©rÃ© avec succÃ¨s"
        echo "ðŸ“„ AperÃ§u du rapport:"
        cat $REPORT_FILE
        
    - name: Upload Terraform Report
      uses: actions/upload-artifact@v4
      with:
        name: terraform-validation-report
        path: reports/terraform-validation-report.md
        retention-days: 30
        
    - name: Success
      run: |
        echo "ðŸŽ‰ Validation Terraform terminÃ©e avec succÃ¨s!"
        echo "ðŸ“Š Rapport de validation gÃ©nÃ©rÃ© et disponible en artifact"
        echo ""
        echo "ðŸ“¥ Pour tÃ©lÃ©charger le rapport:"
        echo "  1. Allez dans l'onglet 'Actions' de GitHub"
        echo "  2. Cliquez sur ce workflow" 
        echo "  3. TÃ©lÃ©chargez l'artifact 'terraform-validation-report'"
        echo ""
        echo "ðŸš€ PrÃªt pour le dÃ©ploiement manuel avec:"
        echo "  ./deploy-manual.sh deploy"
